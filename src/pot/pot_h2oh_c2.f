*  system:  H2O-H, PES
*  written by P. Dagdigian, Sep-2017
*
*  modification of pot_h2oh_34.f -- x and y body-frame axes interchanged
*  to follow MOLSCAT convention
*
*  H2O defined to lie on the xz plane, with the origin at center of mass
*  z axis is the C2 symmetry axis of the CH2 molecule
*  x axis is the a inertial axis of the molecule (perpendicular to C2 axis)
*  when theta = 90, phi = 0, He is on C side of molecule
*  phi = 0 has all 4 atoms coplanar
*
*  the PES is fitted with 24 angular terms

      include "common/syusr"
      include "common/ground"
      include "common/bausr"
* ------------------------------------------------------------------------
      subroutine driver
      implicit double precision (a-h,o-z)
      common /covvl/ vvl(23)
      include "common/parpot"
      s4pi = sqrt ( 4.d0 * acos(-1.d0) )
      econv=219474.6d0
      potnam='H2O-H CCSD(T) C2 PES-24 coeffs'
      print *, potnam
1     print *, 'R (bohr):'
      read (5, *, end=99) r
      call pot(vv0,r)
      if (r.le.0.d0) goto 99
*     vlm coefficient is returned in atomic units (hartree)
*     convert from atomic units for printout
      write (6, 100) vv0*econv*s4pi, (econv*vvl(i), i=1,23)
100   format(' v(lam,0):',9(1pe16.8)/
     :    ' v(lam,2):',7(1pe16.8)/
     :    ' v(lam,4):',5(1pe16.8)
     :    ' v(lam,6):',3(1pe16.8))
      goto 1
99    rr=3.5d0
      dr=0.5d0
      open (unit=12,file='h2oh_c2_vlms.dat')
      write(12,109)
109   format(' %R/bohr V00  ...')
      do i=1,40
        call pot(vv0,rr)
        write (12,110) rr,vv0*econv*s4pi, (econv*vvl(j),j=1,23)
110     format(f7.2,24(1pe16.8))
        rr = rr + dr
      enddo
      close(12)
      end
* ------------------------------------------------------------------------
      subroutine loapot(iunit,filnam)
      implicit double precision (a-h,o-z)
      character*(*) filnam
      include "common/parbas"
      include "common/parpot" 
      common /conlam/ nlam, nlammx, lamnum(4)
      common /cosysi/ nscode, isicod, nterm
      potnam='H2O-H CCSD(T) C2 PES-24 coeffs'
      ibasty = 27
*
      nterm = 4

      mproj(1) = 0
      mproj(2) = 2
      mproj(3) = 4
      mproj(4) = 6

      lammin(1) = 1
      lammin(2) = 2
      lammin(3) = 4
      lammin(4) = 6

      lammax(1) = 8
      lammax(2) = 8
      lammax(3) = 8
      lammax(4) = 8
*
*  molecule is assumed to have C2 symmetry 
*      ipotsy = 2
*
      ntv(1)=1
      ivcol(1,1)=0
      ivrow(1,1)=0
*  calculate total number of anisotropic terms
      nlam = 0
      do i=1,nterm
        lmin = lammin(i)
        lmax = lammax(i)
        lamnum(i)=(lammax(i)-lammin(i)) + 1
        do lb = lmin, lmax
          nlam = nlam + 1
        end do
      end do
      nlammx = nlam
      return
      end
* ----------------------------------------------------------------------
      subroutine pot (vv0, r)
*  subroutine to calculate the r-dependent coefficients
*  in atomic units (distance and energy)
* ----------------------------------------------------------------------
*  on entry:
*    r:          interparticle distance
*  on return:
*    vv0         contains isotropic term (Y00)
*  variable in common block /covvl/
*    vvl:        vector of length 23 to store r-dependence of each term
*                in potential expansion
*    vvl(1-8):   expansion coefficients in Yl0 (l=2:8) of v(lam,0)
*    vvl(9-15):  expansion coefficients in [Yl2 + Y(l,-2)] (l=2:8) of v(lam,2)
*    vvl(16-20): expansion coefficients in [Yl4 - Y(l,-4)] (l=4:8) of v(lam,4)
*    vvl(21-23): expansion coefficients in [Yl6 + Y(l,-6)] (l=6:8) of v(lam,6)
*  variable in common block /coloapot/
*    s4pi:       normalization factor for isotropic potential
*
*  uses linear least squares routines from lapack
*
* author:  paul dagdigian
* latest revision date:  20-sep-2017
* ----------------------------------------------------------------------
* this pes is a fit to 19 values of R and 190 orientations, namely
* R = [3:0.5:10 11 12 13 15 20]
* theta=[0:10:90] and phi=[0:10:180]
*
      implicit double precision (a-h,o-z)
      logical ljunk, ihomo, csflag, lljunk
      include "common/parbas"
      dimension v(34)
      dimension csplin(20,24)
      dimension rr(20), vl(480),vec(24)
      common /colpar/ ljunk(5),csflag,lljunk(2),ihomo
      common /covvl/ vvl(23)
* hyperbolic tangent scaling factor
      data alph /1.2d0/
      data rmax /13d0/
* sqrt(4*pi)
      s4pi = 3.544907701811032d0
* here are the 20 values of R
      data rr/3d0,3.5d0,4d0,4.5d0,5d0,5.5d0,6d0,6.5d0,7d0,7.5d0,
     +  8d0,8.5d0,9d0,9.5d0,10d0,11d0,12d0,13d0,15d0,20d0/
* here are column ordered legendre expansion coefficients (12 total) for the
* potential at each of 20 values of R (480 values)
      data vl/
     + 2.3878472e+04, 1.0481618e+04, 4.3955273e+03, 1.6146137e+03,
     + 4.2168380e+02, -2.8574105e+01, -1.5812778e+02, -1.6545974e+02,
     + -1.3579732e+02, -1.0160100e+02, -7.3038424e+01, -5.1733594e+01,
     + -3.6605738e+01, -2.6046057e+01, -1.8710710e+01, -9.9900941e+00,
     + -5.5754195e+00, -3.2362681e+00, -1.1437902e+00, 1.3819712e-01,
     + -5.8421086e+03, -2.2746264e+03, -1.0438127e+03, -4.7255034e+02,
     + -1.9154429e+02, -6.3026423e+01, -1.0962799e+01, 6.4588744e+00,
     + 1.0020407e+01, 8.8649404e+00, 6.6896004e+00, 4.7156415e+00,
     + 3.2142314e+00, 2.1885938e+00, 1.5078121e+00, 7.2512013e-01,
     + 3.5570401e-01, 1.8861498e-01, 6.0691730e-02, -6.0300776e-03,
     + -4.2735660e+02, -1.2506608e+02, -1.8912186e+01, 7.7596841e+00,
     + 7.7221592e+00, 2.7734833e+00, -8.0829208e-01, -2.3612224e+00,
     + -2.6546602e+00, -2.3889083e+00, -1.9524739e+00, -1.5221754e+00,
     + -1.1689734e+00, -8.7981916e-01, -6.5085300e-01, -3.9607499e-01,
     + -2.4979976e-01, -1.5197660e-01, -4.3835139e-02, -1.5594445e-02,
     + 2.4704063e+03, 8.2984891e+02, 3.5002625e+02, 1.4912516e+02,
     + 5.6799315e+01, 1.7115440e+01, 2.1608145e+00, -2.2692836e+00,
     + -2.9327761e+00, -2.4305957e+00, -1.7544939e+00, -1.1897746e+00,
     + -7.9056787e-01, -5.1843855e-01, -3.2635988e-01, -1.6295210e-01,
     + -7.7788058e-02, -3.3886484e-02, -2.7530729e-02, -6.6206819e-04,
     + -1.1317700e+03, -1.9227028e+02, -5.6720122e+01, -2.4810750e+01,
     + -9.7887539e+00, -2.4129906e+00, 5.5094950e-01, 1.2835173e+00,
     + 1.2285915e+00, 9.4306965e-01, 6.5913924e-01, 4.4059617e-01,
     + 2.8951092e-01, 1.8315765e-01, 1.3167921e-01, 5.1211199e-02,
     + 2.9031933e-02, 9.0269090e-03, 6.5165748e-03, -1.5902025e-03,
     + 1.0661964e+02, -1.9252733e+01, -1.4160642e+01, -4.8693226e+00,
     + -1.3986074e+00, -4.0749790e-01, -1.0721806e-01, -8.2098101e-02,
     + -6.8198973e-02, -5.4305868e-02, -3.7665596e-02, -2.9419516e-02,
     + -1.9015508e-02, -1.2257088e-02, -2.8357370e-03, -4.5573951e-03,
     + 2.5889390e-03, -2.2221734e-03, 1.6410436e-03, -4.4604630e-03,
     + 4.4251587e+02, 7.5256790e+01, 1.5206143e+01, 3.4604074e+00,
     + 6.0821037e-01, -7.6952516e-02, -2.1151883e-01, -1.6098530e-01,
     + -1.1076635e-01, -7.0722017e-02, -4.1057270e-02, -2.4577603e-02,
     + -1.3495540e-02, -1.0420894e-02, -1.0295827e-03, -1.2949385e-03,
     + 3.1931575e-04, 2.4169317e-03, 1.5417709e-04, -8.6840176e-03,
     + -4.2844306e+02, -5.5661564e+01, -6.8439892e+00, -7.1481306e-01,
     + 7.7762295e-02, 1.6029791e-01, 9.6364923e-02, 6.9833184e-02,
     + 4.2352133e-02, 2.6125037e-02, 1.4672026e-02, 1.0627290e-02,
     + 4.5921123e-03, 1.7211475e-03, -5.1627824e-04, 9.0625505e-04,
     + -7.6694276e-04, -4.3417380e-03, -2.2856853e-03, -4.4450714e-04,
     + 1.3442183e+02, 1.3250890e+01, 3.8918997e-01, -2.5197309e-01,
     + -1.4355765e-01, -2.5095850e-02, -1.2077601e-02, -8.6722187e-03,
     + -4.0927278e-03, -3.0314419e-03, -1.3869878e-03, -1.7435526e-03,
     + -4.5186269e-04, 2.1471287e-03, -5.0952816e-03, 1.7885383e-03,
     + -1.1337747e-04, 2.5240121e-04, 1.4860011e-03, 4.6873645e-03,
     + 5.2266240e+03, 1.9893146e+03, 7.8473502e+02, 2.8391342e+02,
     + 8.3558229e+01, 1.2661984e+01, -7.2947427e+00, -9.7837369e+00,
     + -7.6108940e+00, -5.0601934e+00, -3.1574899e+00, -1.9216934e+00,
     + -1.1678962e+00, -7.2190129e-01, -4.5809887e-01, -2.0813966e-01,
     + -1.0341481e-01, -4.8908800e-02, -2.0655900e-02, -2.1210597e-03,
     + -3.3387167e+03, -1.1455787e+03, -4.8683910e+02, -2.0662555e+02,
     + -7.7113057e+01, -2.1718948e+01, -1.0893529e+00, 4.9000647e+00,
     + 5.3940051e+00, 4.3321233e+00, 3.1129055e+00, 2.1370999e+00,
     + 1.4402434e+00, 9.6356396e-01, 6.5078759e-01, 3.1250427e-01,
     + 1.5926050e-01, 8.3500735e-02, 3.6998852e-02, 8.2849727e-04,
     + 1.0274463e+03, 1.9026360e+02, 6.0658715e+01, 2.6940860e+01,
     + 1.0752374e+01, 2.9043529e+00, -2.3011436e-01, -1.1625389e+00,
     + -1.1729926e+00, -9.1787466e-01, -6.4909619e-01, -4.4099756e-01,
     + -2.9111978e-01, -1.9075750e-01, -1.2669411e-01, -5.2889635e-02,
     + -2.3211717e-02, -1.3889357e-02, -9.2559267e-03, -4.8158569e-03,
     + 1.0843142e+02, 5.0866131e+01, 1.8904868e+01, 5.6118122e+00,
     + 1.1547828e+00, 4.8972599e-03, -1.5784080e-01, -1.2902124e-01,
     + -7.2003068e-02, -3.4861993e-02, -1.4263776e-02, -1.1041422e-02,
     + -1.1488361e-03, 1.4891957e-03, -5.1257439e-03, 1.1280517e-03,
     + 3.2671774e-03, 4.4402741e-03, 7.0716349e-03, 2.6789997e-03,
     + -5.3961951e+02, -8.8881368e+01, -1.6834607e+01, -3.5456006e+00,
     + -5.3818317e-01, 1.4288107e-01, 2.6212691e-01, 2.1071948e-01,
     + 1.4206323e-01, 8.9825259e-02, 5.2483261e-02, 2.8516242e-02,
     + 1.9437509e-02, 1.0077693e-02, -1.3103132e-03, 3.2093136e-03,
     + 4.8760065e-03, -3.0678385e-03, -7.6746786e-03, 3.2296116e-03,
     + 4.2132637e+02, 5.4388461e+01, 6.4673590e+00, 6.1775428e-01,
     + -1.2726294e-01, -1.3599006e-01, -1.1925082e-01, -6.9007972e-02,
     + -4.3548730e-02, -2.4555451e-02, -1.5213632e-02, -6.6313378e-03,
     + -5.3642432e-03, -3.7222998e-03, -1.1363014e-02, 5.4660181e-05,
     + 1.6431299e-03, 1.1796947e-03, 5.2655631e-03, -7.9961904e-03,
     + -9.4765102e+01, -7.9365404e+00, 3.3127532e-01, 4.0053091e-01,
     + 1.4144574e-01, 7.6105130e-02, 1.8595236e-02, 7.3866486e-03,
     + 2.5990406e-03, 2.6687006e-03, 9.7004248e-04, 3.9040783e-03,
     + 9.3283264e-04, -5.7820294e-04, -1.0589569e-02, 2.4166541e-03,
     + 6.2456640e-04, -1.6688751e-03, -9.2793431e-04, -1.9356787e-04,
     + 1.2343389e+03, 3.5320999e+02, 1.1699099e+02, 3.7710545e+01,
     + 9.4765761e+00, 3.2643977e-01, -1.8941785e+00, -1.9070496e+00,
     + -1.4043844e+00, -9.2892975e-01, -5.8542389e-01, -3.7060548e-01,
     + -2.2905094e-01, -1.4271048e-01, -8.9237421e-02, -3.7297807e-02,
     + -1.7002804e-02, -6.9873534e-03, 9.4327455e-04, -3.3170938e-03,
     + -1.1800294e+03, -2.4722379e+02, -6.5355986e+01, -1.9220139e+01,
     + -4.8044103e+00, -2.9308389e-01, 8.3166886e-01, 8.9703730e-01,
     + 6.7186307e-01, 4.4644369e-01, 2.7904581e-01, 1.6505051e-01,
     + 1.0385020e-01, 6.3273936e-02, 3.8828542e-02, 1.4947473e-02,
     + 8.9913527e-03, 1.8158463e-03, -3.4723966e-03, 1.8493164e-02,
     + 7.6531964e+02, 1.2550380e+02, 2.3775936e+01, 5.2323377e+00,
     + 9.1818559e-01, -1.4021879e-01, -3.0498685e-01, -2.7984127e-01,
     + -1.9696372e-01, -1.2639399e-01, -7.8008636e-02, -4.6939401e-02,
     + -2.6166446e-02, -1.6237917e-02, -1.0634097e-02, -3.6392040e-03,
     + 2.2511218e-03, -2.3555953e-03, -1.7750009e-03, -2.7043365e-03,
     + -2.8623855e+02, -3.4644301e+01, -3.4263933e+00, -1.1392637e-01,
     + 1.2611292e-01, 1.0141267e-01, 6.6490533e-02, 4.3401588e-02,
     + 2.7218905e-02, 1.6153612e-02, 9.7548872e-03, 6.0249694e-03,
     + 2.0664397e-03, 7.6591682e-04, -8.1013006e-04, 8.2659488e-04,
     + 2.4467936e-03, 8.2314950e-04, 1.4560514e-03, -1.4466493e-04,
     + -5.2414761e+01, -1.1659880e+01, -3.0007939e+00, -7.5934881e-01,
     + -1.8630812e-01, -3.1543973e-02, -4.2220962e-03, 6.2238217e-03,
     + 4.5927144e-03, 2.4219417e-03, 8.4869756e-04, 1.9270780e-04,
     + -1.2934205e-04, 1.0637794e-03, 1.2723504e-03, 2.4168370e-03,
     + 9.9315917e-04, 3.2462002e-04, -1.7159535e-03, -2.1962102e-03,
     + 3.7598551e+02, 8.1183140e+01, 2.0666023e+01, 5.5321444e+00,
     + 1.2880985e+00, 1.2662266e-01, -1.3394030e-01, -1.3402508e-01,
     + -9.4934314e-02, -6.1544786e-02, -3.6672038e-02, -1.8193827e-02,
     + -1.1220292e-02, -5.4454483e-03, -3.2133714e-03, -8.1927486e-04,
     + 2.4788327e-04, 1.3235346e-03, -2.5379179e-03, -4.7492226e-04,
     + -4.1490628e+02, -7.4938589e+01, -1.5921526e+01, -3.6765900e+00,
     + -7.9624121e-01, -7.9071468e-02, 7.7870308e-02, 7.3891337e-02,
     + 5.1034037e-02, 3.2326389e-02, 1.8845214e-02, 1.4215505e-02,
     + 4.8825633e-03, 1.8000005e-03, 1.6934556e-04, 2.1262935e-04,
     + -5.6082640e-05, 3.7442435e-04, 1.2945308e-03, 5.9784921e-03,
     + 3.1530346e+02, 4.7820184e+01, 8.3667365e+00, 1.5953040e+00,
     + 2.8906530e-01, 1.0963718e-02, -2.1902111e-02, -2.5115648e-02,
     + -1.6147972e-02, -8.8143449e-03, -6.0902976e-03, -3.6284367e-03,
     + -8.9688740e-04, 6.9695103e-04, 5.5136818e-04, 2.9733153e-04,
     + -1.0869955e-03, -2.6353525e-03, -4.4779381e-03, -3.3127528e-03 /
*
* spline fit
      if (ifirst .eq. 0) then
* spline fit of the vl coefficients
         ind=1
         do ilam=1,34
           call dcopy(20,vl(ind),1,vec,1)
*    evaluate derivative at first point
           der1=(vec(2)-vec(1))/(rr(2)-rr(1))
           call dspline(rr,vec,20,der1,0d0,csplin(1,ilam))
           ind = ind + 20
         enddo
         ifirst = 1
       end if
* r^-6 fit to isotropic part of potential
       c6sum = -1.9457075e+07
* switching function for long-range
       switch_lr=0.5*(tanh(0.5*(r - 25.d0)) + 1.d0)
* determine splined coefficients at R=r
       ind=1
       do ilam=1,24
         call dcopy(20,vl(ind),1,vec,1)
         call dsplint(rr,vec,csplin(1,ilam),20,r,vvx)
* kill anisotropic terms at large R
         vvx = (1.d0 - switch_lr)*vvx
         if (ilam.eq.1) then
* merge with asymptotic form
            vvx = vvx + switch_lr*c6sum/(r**6)
         endif
         v(ilam)=vvx
         call dcopy(20,vl(ind),1,vec,1)
         ind = ind + 20
       enddo
       call dcopy(33,v(2),1,vvl(1),1)
* convert to hartree
       econv=1.d0/219474.6d0
       call dscal(23,econv,vvl,1)
* isotropic term - divide by sqrt(4*pi)
       vv0 = v(1)*econv/s4pi
*
       return
       end
